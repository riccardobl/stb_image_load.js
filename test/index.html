<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Load and Display Image</title>
    <script src="./stb_image_load.js"></script>
    <style>
        
        body{
            background-color: #333;
            color: #afafaf;
            text-align: center;
          
  
        }
      
        canvas{
        }
    </style>
    <script>
        async function load(imageUrl,canvas,infoEl){
            // load to Uint8Array
            const imageData=new Uint8Array(await (await fetch(imageUrl)).arrayBuffer());
            const loadedData=await StbImageLoad.load_image(imageData.length,i=>{
                return imageData[i];
            });
            const {width,height,channels,data,bpc,bpp}=loadedData;

            const info=(...args)=>{
                infoEl.innerHTML+=args.join(" ")+"<br>";
                console.info(...args);
            };

            info("width:",width);
            info("height:",height);
            info("channels:",channels);
            info("bits per channel:",bpc);
            info("bits per pixel:",bpp);
            const ctx = canvas.getContext('2d');

            if(bpc==8){ // 8bit
                const image = new ImageData(loadedData.width, loadedData.height);
                image.data.set(loadedData.data);             
                ctx.putImageData(image, 0, 0);
            }else{ // 16 bit
                const data16bit=new Uint16Array(loadedData.data );
                const data8bit=new Uint8ClampedArray(loadedData.width*loadedData.height*4);
                for(let i=0;i<data16bit.length;i++){
                    data8bit[i]=Math.floor((data16bit[i]/65536.)*255);
                }                
                const image = new ImageData(loadedData.width, loadedData.height);
                image.data.set(data8bit);             
                ctx.putImageData(image, 0, 0);
            }

            // free memory
            await StbImageLoad.free(loadedData);

        }

        async function main(){
            const infoEl=document.getElementById("#info");
            const canvas = document.getElementById('imageCanvas');
            await load("./test.png",canvas,infoEl);
            const infoEl2=document.getElementById("#info2");
            const canvas2 = document.getElementById('imageCanvas2');
            await load("./test16bitI.png",canvas2,infoEl2)
        }

        window.addEventListener("load",main);
    </script>
</head>
<body>
    <canvas id="imageCanvas" width="400" height="300"></canvas>
    <div id="#info"></div>
    <canvas id="imageCanvas2" width="400" height="300"></canvas>
    <div id="#info2"></div>

</body>
</html>
